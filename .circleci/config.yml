version: 2.1

orbs:
  gh: circleci/github-cli@2

jobs:
  build-and-publish:
    macos:
      xcode: "26.2"
    resource_class: m4pro.medium
    working_directory: ~/project
    environment:
      REPO_FULL_NAME: "inlineapps/host-ios-carthage"

    steps:
      - checkout

      # 1. Read version from VERSION file
      - run:
          name: Read version from VERSION file
          command: |
            VERSION=$(cat VERSION)
            TAG="v$VERSION"
            echo "Using TAG: $TAG"
            echo "export TAG=$TAG" >> $BASH_ENV

      # 2. Create and push git tag (local → remote)
      - run:
          name: Create and push tag
          command: |
            git config user.email "ci@circleci.com"
            git config user.name "CircleCI"

            # ignore if tag exist
            if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
              echo "Tag $TAG already exists on remote."
            else
              echo "Creating and pushing tag $TAG"
              git tag "$TAG"
              git push origin "$TAG"
            fi

      # Install Carthage
      - run:
          name: Install Carthage
          command: |
            brew update
            brew install carthage

      # Build Carthage
      - run:
          name: Build XCFramework Using Carthage
          command: |
            carthage bootstrap --use-xcframeworks --platform iOS --no-use-binaries --cache-builds

            mkdir -p output
            cp -R Carthage/Build/*.xcframework output/

      # Zip frameworks
      - run:
          name: Zip XCFrameworks
          command: |
            cd output
            for f in *.xcframework; do
              zip -r "${f}.zip" "$f"
            done

      - run:
          name: Compute checksums for all XCFramework zips
          command: |
            echo "Generating checksums…"

            CHECKSUM_NOTE=""

            for FILE in output/*.zip; do
              NAME=$(basename "$FILE")
              SUM=$(swift package compute-checksum "$FILE")
              echo "$NAME checksum: $SUM"

              CHECKSUM_NOTE="${CHECKSUM_NOTE}${NAME}: ${SUM}\n"
            done

            echo -e "$CHECKSUM_NOTE"

            # Export for next steps
            echo "export CHECKSUM_NOTE=$(printf '%q' "$CHECKSUM_NOTE")" >> $BASH_ENV
            
      # Install GitHub CLI
      - gh/install:
          version: latest

      # 3. Create Release under the tag
      - run:
          name: Create GitHub Release
          command: |
            gh release create "$TAG" \
              --title "$TAG" \
              --notes "$(printf "Support Xcode $VERSION\n\nChecksums:\n$CHECKSUM_NOTE")" || true

      # 4. Save output folder to artifacts
      - store_artifacts:
          path: output
          destination: xcframeworks

      # 5. Upload assets (XCFrameworks)
      - run:
          name: Upload assets to Release
          command: |
            for file in output/*.zip; do
              echo "Uploading $file"
              gh release upload "$TAG" "$file" --clobber
            done

workflows:
  build-and-release:
    jobs:
      - build-and-publish:
          filters:
            branches:
              only: master